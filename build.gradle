/*
 * This file was generated by the Gradle 'init' task as part of the project migration from Maven.
 */


import org.jooq.codegen.gradle.CodegenPluginExtension
import org.testcontainers.containers.PostgreSQLContainer
import org.gradle.api.services.BuildServiceParameters
import org.gradle.api.services.BuildService

buildscript {
    repositories {
        mavenCentral()
    }

    dependencies {
//      Required dependencies to start testcontainers and do the migration during the build.
        classpath 'org.testcontainers:postgresql:1.19.3'
        classpath 'org.flywaydb:flyway-database-postgresql:10.4.0'
    }
}

plugins {
    id 'java-library'

//  Gradle plugins for jOOQ and Flyway.
    id 'org.flywaydb.flyway' version '10.4.0'
    id 'org.jooq.jooq-codegen-gradle' version '3.19.1'
}

repositories {
    mavenLocal()
    maven {
        url = uri('https://repo.maven.apache.org/maven2/')
    }
}

group = 'com.sergeylappo.testcontainers'
version = '1.0.0-SNAPSHOT'
description = 'tc-guide-working-with-jooq-flyway-using-testcontainers-gradle'
java.sourceCompatibility = 17

dependencies {
    implementation "org.springframework.boot:spring-boot-starter-jooq:$spring_boot_version"

//  Dependencies required for the application to use jooq and flyway in runtime.
    implementation "org.flywaydb:flyway-database-postgresql:$flyway_version"
    implementation "org.jooq:jooq:$jooq_version"

//  Your database driver
    runtimeOnly "org.postgresql:postgresql:$postgres_version"
//  Database driver for the build time.
    jooqCodegen "org.postgresql:postgresql:$postgres_version"

    testImplementation "org.springframework.boot:spring-boot-devtools:$spring_boot_version"
    testImplementation "org.springframework.boot:spring-boot-starter-test:$spring_boot_version"
    testImplementation "org.springframework.boot:spring-boot-testcontainers:$spring_boot_version"

//  Testcontainer dependencies for the test tasks.
    testImplementation "org.testcontainers:junit-jupiter:$testcontainers_version"
    testImplementation "org.testcontainers:postgresql:$testcontainers_version"
}

// Here we register service for providing our database during the build.
Provider<PostgresService> dbContainerProvider = project.getGradle()
        .getSharedServices()
        .registerIfAbsent("postgres", PostgresService.class, {})


tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

tasks.withType(Javadoc) {
    options.encoding = 'UTF-8'
}

test {
    useJUnitPlatform()

//  This is only necessary if you want to reuse container for the tests.
    usesService dbContainerProvider
    doFirst {
        def dbContainer = dbContainerProvider.get().container
        systemProperty('spring.datasource.url', dbContainer.jdbcUrl)
        systemProperty('spring.datasource.username', dbContainer.username)
        systemProperty('spring.datasource.password', dbContainer.password)
    }
}

flywayMigrate {
//  We need access to our database during the build.
    usesService dbContainerProvider
//  Define location of the migrations.
    locations = ["filesystem:src/main/resources/db/migration"]
//  Flyway plugin won't define input files for us, so to follow Gradle convention define them.
    inputs.files(fileTree("src/main/resources/db/migration"))

    doFirst {
        def dbContainer = dbContainerProvider.get().container
//      Set up the flyway config.
        url = dbContainer.jdbcUrl
        user = dbContainer.username
        password = dbContainer.password
    }
}

afterEvaluate {
//  For jOOQ to run we always need for flyway to be completed before.
    jooqCodegen.dependsOn flywayMigrate
    jooqCodegen {
        doFirst {
            def dbContainer = dbContainerProvider.get().container
            jooq {
                configuration {
                    jdbc {
                        driver = "org.postgresql.Driver"
                        url = dbContainer.jdbcUrl
                        user = dbContainer.username
                        password = dbContainer.password
                    }
                }
            }
        }
    }
}

jooq {
//  jOOQ generation config
    configuration {
        logging = org.jooq.meta.jaxb.Logging.WARN
        generator {
            name = "org.jooq.codegen.DefaultGenerator"
            database {
                name = "org.jooq.meta.postgres.PostgresDatabase"
                includes = ".*"
                excludes = 'flyway_schema_history'
                inputSchema = 'public'
            }
            target {
                packageName = 'com.testcontainers.demo.jooq'
                directory = 'target/generated-sources/jooq'
            }
        }
    }
}

/**
 * Build service for providing database container.
 */
abstract class PostgresService implements BuildService<BuildServiceParameters.None>, AutoCloseable {
    private final PostgreSQLContainer container;

    PostgresService() {
//        Services are initialized lazily, on first request to them, so we start container immediately.
        container = new PostgreSQLContainer("postgres:16-alpine")
        container.start()
    }

    @Override
    void close() {
//        Ensure to stop container in the end
        container.stop()
    }

    PostgreSQLContainer getContainer() {
        return container
    }
}